#!/usr/bin/env bash
set -euo pipefail

# Resolve through symlinks to find the real script directory
SOURCE="$0"
while [[ -L "$SOURCE" ]]; do
    DIR="$(cd "$(dirname "$SOURCE")" && pwd)"
    SOURCE="$(readlink "$SOURCE")"
    [[ "$SOURCE" != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$(cd "$(dirname "$SOURCE")" && pwd)"

IMAGE="speak:latest"

VOICE="Vivian"
OUTPUT=""
TEXT=""
INSTRUCT=""

usage() {
    cat <<'EOF'
Usage: speak [OPTIONS] -o OUTPUT TEXT

Generate speech from text using Qwen3-TTS.

Options:
  --voice, -v      Speaker voice (default: Vivian)
                    Available: aiden, dylan, eric, ono_anna, ryan, serena, sohee, uncle_fu, vivian
  --output, -o     Output .wav path (required)
  --instruct, -i   Voice style instruction, e.g. "whisper" or "Very happy." (optional)
  --help, -h       Show this help

Examples:
  speak -o hello.wav "Hello world"
  speak -v ryan -o greeting.wav "Hi there"
  speak -i "whisper" -o secret.wav "This is a secret"
EOF
    exit 0
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        --voice|-v)
            VOICE="$2"; shift 2 ;;
        --output|-o)
            OUTPUT="$2"; shift 2 ;;
        --instruct|-i)
            INSTRUCT="$2"; shift 2 ;;
        --help|-h)
            usage ;;
        -*)
            echo "Error: unknown option: $1" >&2; exit 1 ;;
        *)
            TEXT="$1"; shift ;;
    esac
done

if [[ -z "$OUTPUT" ]]; then
    echo "Error: --output/-o is required" >&2
    echo "Usage: speak [OPTIONS] -o OUTPUT TEXT" >&2
    exit 1
fi

if [[ -z "$TEXT" ]]; then
    echo "Error: no text provided" >&2
    echo "Usage: speak [OPTIONS] -o OUTPUT TEXT" >&2
    exit 1
fi

# Build image if it doesn't exist
if ! docker image inspect "$IMAGE" &>/dev/null; then
    echo "Building $IMAGE (one-time)..." >&2
    docker build -t "$IMAGE" "$SCRIPT_DIR"
fi

# Resolve output to absolute path
case "$OUTPUT" in
    /*) ABS_OUTPUT="$OUTPUT" ;;
    *)  ABS_OUTPUT="$(pwd)/$OUTPUT" ;;
esac
OUTPUT_DIR="$(dirname "$ABS_OUTPUT")"
OUTPUT_FILE="$(basename "$ABS_OUTPUT")"

INSTRUCT_ARGS=()
if [[ -n "$INSTRUCT" ]]; then
    INSTRUCT_ARGS=(--instruct "$INSTRUCT")
fi

exec docker run --gpus all --rm --ipc=host \
    --entrypoint python \
    -e HF_HUB_OFFLINE=1 \
    -v "$SCRIPT_DIR:/opt/speak:ro" \
    -v "$OUTPUT_DIR:/output" \
    "$IMAGE" \
    -u /opt/speak/generate.py \
        --text "$TEXT" \
        --voice "$VOICE" \
        --output "/output/$OUTPUT_FILE" \
        "${INSTRUCT_ARGS[@]}"
